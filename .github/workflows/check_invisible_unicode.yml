name: Invisible Unicode Check

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  check_unicode:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Find and Check for Invisible Characters
        id: unicode_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Define invisible Unicode characters to check for
          INVISIBLE_CHARS=$(printf '\u200B\u200C\u200D\uFEFF\u2060\u00AD\u200E\u200F')

          FILES_TO_CHECK=""

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Use the GH CLI to get changed files in the PR
            gh pr checkout ${{ github.event.pull_request.number }}
            FILES_TO_CHECK=$(gh pr diff ${{ github.event.pull_request.number }} --name-only | tr '\n' ' ')
          else
            # For push: diff from previous commit (event.before)
            FILES_TO_CHECK=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi

          if [ -z "$FILES_TO_CHECK" ]; then
            echo "‚úÖ No files changed, skipping check."
            exit 0
          fi

          echo "Files to check: $FILES_TO_CHECK"

          # Scan the files for invisible characters
          ERROR_OUTPUT=$(echo "$FILES_TO_CHECK" | xargs grep -PHn "[$INVISIBLE_CHARS]" 2>&1 || true)

          if [ -n "$ERROR_OUTPUT" ]; then
            echo "‚ùå ERROR: Invisible Unicode Characters found in the following files/lines:"
            echo "---"
            echo "$ERROR_OUTPUT"
            echo "---"
            echo "Please remove the invisible characters (e.g., zero-width spaces) from these locations."
            exit 1
          else
            echo "‚úÖ No invisible Unicode characters found in the changed files."
          fi
